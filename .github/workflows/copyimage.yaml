name: Copy Docker Image

on:
  push:
    branches:
      - CopyDockerImage

jobs:
  copy-image:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1
      
    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Pull Docker image
      run: docker pull sfalexrog/img-tool:qemu-update
      
    - name: Create docker_image directory
      run: mkdir -p docker_image
      
    - name: Save Docker image to tar file
      run: docker save -o docker_image/img-tool_qemu-update.tar sfalexrog/img-tool:qemu-update
      
    - name: Extract Docker image contents
      run: tar -xvf docker_image/img-tool_qemu-update.tar -C docker_image
      
    - name: Remove tar file
      run: rm docker_image/img-tool_qemu-update.tar

    - name: Configure git
      run: |
        git config --global user.email "${{ secrets.GIT_USER_EMAIL }}"
        git config --global user.name "${{ secrets.GIT_USER_NAME }}"

    - name: Commit and push changes
      run: |
        git pull origin ${{ github.ref_name }}
        git add docker_image
        git commit -m "Add files from Docker image sfalexrog/img-tool:qemu-update"
        git push origin ${{ github.ref_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
